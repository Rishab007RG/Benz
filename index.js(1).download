/*! vehicle-context-automation 1.4.0-alpha.d7c9563-SNAPSHOT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@seamless/logger"),require("@seamless/store")):"function"==typeof define&&define.amd?define(["exports","@seamless/logger","@seamless/store"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["vehicle-context-automation"]={},e.seamlessLogger,e.seamlessStore)}(this,(function(e,t,n){"use strict";
/*! connection-vehicle-data 1.2.0-alpha.eb4ff0f-SNAPSHOT */var r,o;!function(e){e.Primary="primary",e.Secondary="secondary",e.Shop="shop",e.Configurator="configurator",e.About="about",e.Enquiry="enquiry",e.Informed="informed"}(r||(r={})),function(e){e.UpdateCta="UPDATE_CTA",e.UpdatePrice="UPDATE_PRICE"}(o||(o={}));const i="OWC_VEHICLE_DATA",s={modelSeries:"",engineConcept:"",subBrands:[]};new class extends n.SeamlessConnection{constructor(){super(i)}get initialState(){var e,t,n;const r=(null===(e=window.aemNamespace)||void 0===e?void 0:e.vehicleData)||(null===(n=null===(t=window.top)||void 0===t?void 0:t.aemNamespace)||void 0===n?void 0:n.vehicleData)||{};return Object.assign(Object.assign({},s),r)}getReducer(){return(e=s,t)=>{switch(t.type){case this.getActionType(o.UpdateCta):return Object.assign(Object.assign({},e),{cta:Object.assign(Object.assign({},e.cta),t.payload)});case this.getActionType(o.UpdatePrice):return Object.assign(Object.assign({},e),{price:Object.assign(Object.assign({},e.price),t.payload)});default:return e}}}getPublicDispatchers(){return{setCta:e=>this.getAction(o.UpdateCta,e),setPrice:e=>this.getAction(o.UpdatePrice,e)}}};const a=()=>function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}(void 0,void 0,void 0,(function*(){const e=n.initializeStore();return yield e.getConnectionDispatchers(i)})),c="cta-automation-service";var u,d,l,f;!function(e){e.Configurator="CONFIGURATOR",e.OnlineShop="ONLINE_SHOP",e.ProductPage="PRODUCT_PAGE",e.TestDrive="TEST_DRIVE",e.Enquiry="ENQUIRY",e.Informed="INFORMED"}(u||(u={})),function(e){e.Publish="PUBLISHER",e.Author="AUTHOR"}(d||(d={})),function(e){e.Primary="primary",e.Secondary="secondary",e.Shop="shop",e.Configurator="configurator",e.Info="info",e.CarDrive="cardrive",e.Enquiry="enquiry",e.Informed="informed"}(l||(l={})),function(e){e.Default="default",e.Alternative="alternative"}(f||(f={}));const g=[u.Configurator,u.OnlineShop],p=[u.Configurator],h=[u.OnlineShop,u.ProductPage],m=[u.ProductPage],b=(e,t)=>t.every((t=>Object.keys(e).includes(t))),v=(e,t=!1,n=f.Default)=>{switch(!0){case b(e,g):return t?w(n):[u.OnlineShop,u.ProductPage];case b(e,p):return t?[u.Configurator,u.Enquiry]:[u.Configurator,u.ProductPage];case b(e,h):return t?[u.OnlineShop]:[u.OnlineShop,u.ProductPage];case b(e,m):return t?[u.Enquiry]:[u.ProductPage]}return[]},w=e=>e===f.Default?[u.OnlineShop,u.Configurator]:[u.OnlineShop,u.Enquiry],y=t.initializeLogger(c),$=async e=>{const t=(()=>{try{const e=localStorage.getItem("cta_service.deeplink_response_mock_data");if(e){const t=JSON.parse(e);return y.log("Skipping sending request to the deeplink service and using mock data from the local storage:",t),t}}catch(e){y.error("An error occurred during injecting deep link data from the local storage:",e.message)}})();if(t)return t;try{y.log(`Sending request to ${e}`);const t=await fetch(e),n=await t.json();if(t.ok)return n}catch(e){throw Error("Error caused during processing request to deep link service")}},S=(e,{runMode:t,country:n,language:r,modelSeries:o,subBrands:i})=>{const s="AUTHOR"===t?d.Author:d.Publish;return`${e}/vehicle-deeplinks-api/v1/deeplinks/${n}/${r}/model-series/${o}?${new URLSearchParams([...(i||[]).map((e=>["subBrands",e])),["cmsInstance",s]])}`},O=(e,...t)=>{const n=[l.Primary,l.Secondary,l.Shop,l.Configurator,l.Info,l.Enquiry,l.Informed];if(!t.length)return;const r=t.reduce(((t,r,o)=>{const i=n[o],s=e[r];return i&&s&&(t[i]=s),t}),{});return Object.keys(r).length?r:void 0},E="OWC_AEM_ENV";new class extends n.SeamlessConnection{constructor(){super(E)}get initialState(){const e=window.aemNamespace?.environmentVariables||window.top?.aemNamespace?.environmentVariables,t=window.aemNamespace?.pageEnvironmentVariables||window.top?.aemNamespace?.pageEnvironmentVariables;return e&&t?{...e,...t}:{}}getReducer(){return()=>this.initialState}getPublicDispatchers(){return{}}};const N=e=>{const t=n.initializeStore(),r=n=>{e(n,(()=>t.unsubscribe(i,r)))};t.subscribe(i,r)},A=()=>new Promise((e=>{n.initializeStore().once(E,e)})),C=t.initializeLogger(c),P="price-automation-service",R=t.initializeLogger(P);var U,_;!function(e){e.Price="PRICE"}(U||(U={})),function(e){e.Cars="PASSENGER_CAR",e.Vans="VANS"}(_||(_={}));const j=(e,t)=>{if("SGD"===e.unit){const n=Number("min"===t?e.min:e.max);return D(n,e.unit,",",".")}return Intl.NumberFormat(`${e.language}-${e.country}`,{style:"currency",currency:`${e.unit}`}).format(Number("min"===t?e.min:e.max))},D=(e,t,n=".",r=",")=>{const[o,i="00"]=e.toFixed(2).split(".");return`${o.replace(/\B(?=(\d{3})+(?!\d))/g,n)}${r}${i} ${t}`},T=t.initializeLogger(P),B=async(e,t,n=[])=>{const{apiUri:r,country:o,language:i}=await A();if(r&&e)try{const s=((e,{country:t,language:n,modelSeries:r,engineConcept:o,subBrands:i})=>{const s=_.Cars,a=new URL(`${e}/vmds-highlights-api/v1/highlights/${t}/${n}/${s}/${r}`);for(const e of i)a.searchParams.append("subBrands",e);return o&&a.searchParams.append("engineConcept",o),a.toString()})(r,{country:o,language:i,modelSeries:e,engineConcept:t,subBrands:n}),a=await(async e=>{try{R.log(`Sending request to ${e}`);const t=await fetch(e),n=await t.json();if(t.ok)return n}catch(e){throw Error("Error caused during processing request to VMDS service")}})(s);if(!a)return void T.log(`No data loaded from VMDS service for ${e}`);T.log(`Data for ${e} has been loaded:`,a);const c=((e,t,n)=>{const r=e.i18n,o=e.highlights[U.Price],{unit:i,footnoteI18nKey:s}=o,a={min:String(o.min),max:String(o.max),unit:o.unit,language:t,country:n},c={unit:i,min:j(a,"min"),max:j(a,"max"),pricePrefixLabel:r.PRICE};return s&&r[s]&&(c.priceFootnoteLabel=r[s]),c})(a,i,o);return T.log(`Formatted price for ${e} have been returned:`,c),c}catch(e){T.error(e.message)}else T.log("No apiUri or modelSeries found, skipping price service initialization")};(async()=>{const{modelSeries:e}=await new Promise((e=>{n.initializeStore().once(i,e)}));e&&(N((async({modelSeries:e,subBrands:t,cta:n={}},r)=>{const{apiUri:o,runMode:i,country:s,language:c,vehicleData:d}=await A(),{informed:l,enquiry:g}=n;let p=f.Default;if(o&&e)try{const n=S(o,{runMode:i,country:s,language:c,modelSeries:e,subBrands:t});let f=await $(n);if(!f)return void C.log(`No data loaded from deep link service for ${e}`);C.log(`Data for ${e} has been loaded:`,f),f={...f,[u.Enquiry]:g,[u.Informed]:l},d?.cta&&(p=d.cta.scenario,C.log(`Automated CTA scenario switched to ${p}`));const h=v(f,!0,p);C.log("Mapping buttons for the following scenario:",h);const m=O(f,...h);m?(r(),(await a()).setCta(m),C.log(`Buttons for ${e} have been added to the store:`,m)):C.log(`No buttons for ${e} added to the store`)}catch(e){C.error(e.message)}else C.log("No apiUri or modelSeries found, skipping CTA service initialization")})),N((async({modelSeries:e,engineConcept:t,subBrands:n},r)=>{r();const o=await B(e,t,n);o?((await a()).setPrice(o),T.log(`Price data for ${e} have been added to the store:`,o)):T.log(`No price data for ${e} added to the store`)})))})(),e.loadCtaConfiguration=async(e,t=[],n,r,o)=>{const{country:i,language:s,apiUri:a,runMode:c}=await A();if(!a)return void C.log("No apiUri found, skipping CTA service initialization");const d=S(a,{runMode:c,country:i,language:s,modelSeries:e,subBrands:t}),l=await $(d);if(l){C.log(`Data for ${e} has been loaded:`,l),n&&(l[u.Enquiry]=n),r&&(l[u.Informed]=r);const t=v(l,!1,o);C.log("Mapping buttons for the following scenario:",t);const i=O(l,...t);if(i)return C.log(`Buttons for ${e} have been returned:`,i),i;C.log(`No buttons for ${e} returned`)}},e.loadPriceData=B,Object.defineProperty(e,"t",{value:!0})}));
//# sourceMappingURL=index.js.map
